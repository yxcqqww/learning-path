/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 项目名称：成都地铁
 2. 页面名称：stations (车站地图页)
 3. 作者：赵华刚(zhaohuagang@guanaihui.com)
 4. 备注：对api的依赖：jQuery
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
function StationsController() {
    this.domain = "http://testapi.cddtwx.cn/" ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    页面滚动到什么坐标位置让市中心恰好显示在页面中间
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.centerLongitude = 430 ;
    this.centerLatitude = 100 ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    站点圆圈的半径
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.cycleRadius = 13 ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    导航向导的路线图是否需要动画效果，默认不要
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.guideAnimation = false ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    ajax接口地址
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.allStationsApiUrl = this.domain + "/api/Metro/GetAllStation" ;
    this.navigatorApiUrl = this.domain + "/api/Metro/MetroPathQuery" ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    车站信息和查看详情两个链接的地址的前缀
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.stationDetailUrlPrefix = this.domain + "/metro/stationdetail" ;
    this.queryDetailUrlPrefix = this.domain + "/metro/metroquery" ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    从Controller基类继承
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    Controller.call(this) ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    导航开始后圆圈闪动的定时触发的定时器
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.timer = {} ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    绑定事件
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.mapLoaded() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    页面加载的时候就将滚动条滚动到市中心正好在页面中心
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    //this.initPosition() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    绘制站点
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/    
    this.drawStations() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    绘制位置图标
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.drawLocationIcon() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    绑定事件
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.bind() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    改变起点终点位置
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.changeHere();
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    初始化跳转链接
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.initNativeRedirectUrl();
}
StationsController.prototype.response=function(type,stationName){
    var self=this;
    for(var i=0;i<$('.cycle').length;i++){
        $('.cycle').eq(i).css('opacity','0.01');
        if($('.cycle').eq(i).attr('data-name')==stationName){
            $cycle=$('.cycle').eq(i);
        }
    }
    if(type==0){
        $cycle.trigger('click');
        $("#setAsStart").trigger('click')
        $('.context-menu').hide();
        $('#childOne').children('i').html(stationName);
        self.setKey(0);
        self.navigate();
    }else if(type==1){
        $cycle.trigger('click');
        $("#setAsTerminal").trigger('click')
        $('.context-menu').hide();
        $('#childTwo').children('i').html(stationName);
        self.setKey(1);
        self.navigate();
    }
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
图片加载完毕关闭提示
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
StationsController.prototype.mapLoaded = function() {    
    $(".map img").one('load', function() {
        $(".loading").fadeOut(200) ;
    }).each(function() {
        if(this.complete) $(this).load();
    });
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
判断是否可以触发计算
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
StationsController.prototype.isReady = function() {
    if($("#startId").val() == "" || $("#terminalId").val() == "") return false ;
    return true ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
页面加载的时候就将滚动条滚动到市中心正好在页面中心
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
StationsController.prototype.initPosition = function() {
    var classSelf = this ;
    $("html,body").animate({
        scrollLeft : classSelf.centerLonigtude + "px" ,
        scrollTop : classSelf.centerLatitude + "px"       
    }, 500) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
绘制位置图标
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
StationsController.prototype.drawLocationIcon = function() {
    $(document.body).append($(document.createElement("DIV")).addClass("location start")) ;
    $(document.body).append($(document.createElement("DIV")).addClass("location terminal")) ;
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
绘制站
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
StationsController.prototype.drawStations = function() {
    var classSelf = this ;    
    this.request(this.allStationsApiUrl, {}, {
        process : function(data) {            
            $(data.returnObject).each(function(){
                var $cycle = $(document.createElement("DIV")).attr("id", this.cName).attr("data-name", this.cName).addClass("cycle").css({ "width" : classSelf.cycleRadius * 2 + "px" , "height" : classSelf.cycleRadius * 2 + "px" ,  "left" : (this.x - classSelf.cycleRadius) + "px" , "top" : (this.y - classSelf.cycleRadius) + "px" }).fadeTo(200, .01) ;
                $(document.body).append($cycle) ;
                $cycle.click(function(event){
                    var offset={
                        left:event.pageX,
                        top:event.pageY,
                      };
                    $(".context-menu").show().css({ "left" : offset.left + "px" , "top" : offset.top + "px" }).attr("data-target", $(this).attr("id")) ;
                    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                    改变车站信息链接地址
                    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                    $("#viewStationDetail").attr("href", classSelf.stationDetailUrlPrefix + "?name=" + encodeURIComponent($(this).attr("id"))) ;
                    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                   功能菜单中当前站点名称改掉
                    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                    $(".context-menu .selected-station").text($(this).attr("data-name")) ;
                    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                    阻止事件冒泡
                    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                    event.stopPropagation() ;
                }) ;
            }) ;
        } 
    }) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
绑定事件
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
StationsController.prototype.bind = function() {    
    var classSelf = this ;
    $(document.body).click(function(){
        $(".context-menu").hide() ;
    }) ;
    $("#setAsStart").click(function(){
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        首先要做判断，是否选择了终点站，如果选择了并且和想要选择的起点站一样，就清楚掉终点站设置
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/         
        if($("#terminalId").val() === $(".context-menu").attr("data-target")) {
            classSelf.clearKey("terminal") ;
        }
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        设置关键站点信息
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        classSelf.setKey("start");        
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        开始导航
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        classSelf.navigate() ;
    }) ;
    $("#setAsTerminal").click(function() {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        首先要做判断，是否选择了起点站，如果选择了并且和想要选择的终点站一样，就清楚掉起点站设置
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/         
        if($("#startlId").val() === $(".context-menu").attr("data-target")) {
            classSelf.clearKey("start") ;
        }
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        设置关键站点信息
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        classSelf.setKey("terminal");
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        开始导航
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        classSelf .navigate() ;

    }) ;
    var flag=0;
    $(".mask").click(function(){
        if($('.location.terminal').css('display')=='block' && $('.location.start').css('display')=='block'){
            classSelf.reset();
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                阻止事件冒泡
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                event.stopPropagation() ;
            if(flag!=0){
                
                flag--;
            }else{
                flag++;
            }
        }
    }) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
计算并开始导航
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
StationsController.prototype.navigate = function() {
    if( ! this.isReady()) return ;
    var classSelf = this ;
    this.request(this.navigatorApiUrl, { "startStation" : $("#startId").val() , "endStation" : $("#terminalId").val() }, {
        process : function(data) {
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            遮罩层打开
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(".mask").show();
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            让相关站点亮起来
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(data.returnObject.stationCollection).each(function(index, element){
                var callback = null ;
                if(classSelf.guideAnimation) {
                    callback = function(){
                        classSelf.timer[index] = window.setInterval(function(){
                            $("#" + element.cName).fadeTo(500, 0).fadeTo(500, 1) ;
                        }, 2000) ;                        
                    } ;
                }
                $("#" + element.cName).delay(100 * index).fadeTo(500, 1, callback) ;                     
            });
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            概述写进去
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $('.infoCar span em b').eq(0).html(data.returnObject.routeTime+'分钟');
            $('.infoCar span em b').eq(1).html('途经'+data.returnObject.stationCount+'站');
            $('.infoCar span em b').eq(2).html(data.returnObject.ticketPrice+'元');
            $(".memo .summary").html(data.returnObject.summary) ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            查看更多详情链接地址改变，要先清空两个隐藏域的值
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(".memo").click(function(event){   
                event.stopPropagation();             
                var startId = encodeURIComponent($("#startId").val()) ;
                var terminalId = encodeURIComponent($("#terminalId").val()) ;
                $("#startId").val("") ;
                $("#terminalId").val("") ;
                window.location = classSelf.queryDetailUrlPrefix + "?start=" + startId + "&end=" + terminalId ;
            }) ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            同时地图还要滚动到起点位置，下面的scrollTop位置为什么要减去100，是要算上memo条的高度，别让memo条遮住了路线，scrollLeft为什么药减去30，是别离左边界太近
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            /*
            var pos = $("#" + $("#startId").val()).position() ;             
            $("html,body").animate({
                scrollLeft : (pos.left - 30) + "px" ,
                scrollTop : (pos.top - 100) + "px"
            }, 500) ;
            */
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            显示下面的浮动层
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(".memo").show() ;
        } 
    }) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
设置关键点
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
StationsController.prototype.setKey = function(keySign) {
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    把起点站写到隐藏域里面去
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    if(keySign =='start'){
        $('.startEnd .metro em').eq(0).children('i').html($(".context-menu").attr("data-target"));
    }else if(keySign == 'terminal'){
        $('.startEnd .metro em').eq(1).children('i').html($(".context-menu").attr("data-target"));
    }
    if(keySign==0 || keySign=="start"){
        keySign="start";
        $("#" + keySign + "Id").val($(".context-menu").attr("data-target")) ;   
    }else if(keySign==1 || keySign=="terminal"){
        keySign="terminal";
        $("#" + keySign + "Id").val($(".context-menu").attr("data-target")) ;
    }
    
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    关键点站图标移动到相应位置并显示
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    var pos={
      left:$("#" + $(".context-menu").attr("data-target"))[0].offsetLeft,
      top:$("#" + $(".context-menu").attr("data-target"))[0].offsetTop
    };
    if(keySign==0 || keySign=="start"){
       keySign="start";
       $(".location." + keySign).css({ "left" :  (pos.left + this.cycleRadius - 20) + "px" , "top" : (pos.top + this.cycleRadius - 48) + "px" }).show() ;
       $(".memo ." + keySign + "-station").html($("#" + $(".context-menu").attr("data-target")).attr("data-name")) ;
    }else if(keySign==1 || keySign=="terminal"){
        keySign="terminal";
        $(".location." + keySign).css({ "left" :  (pos.left + this.cycleRadius - 20) + "px" , "top" : (pos.top + this.cycleRadius - 48) + "px" }).show() ;
        $(".memo ." + keySign + "-station").html($("#" + $(".context-menu").attr("data-target")).attr("data-name")) ;
    }
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    把关键点站名写到memo里面去
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
设置关键点
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
StationsController.prototype.clearKey = function(keySign) {
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    把隐藏域值清空
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $("#" + keySign + "Id").val() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    图标隐藏
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/    
    $(".location." + keySign).hide() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    memo里面信息清空
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $(".memo ." + keySign + "-station").empty() ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
重置页面
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
StationsController.prototype.reset = function() {
    $('.startEnd .metro em').eq(0).children('i').html('起点');
    $('.startEnd .metro em').eq(1).children('i').html('终点');
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    遮罩层关闭
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/    
    $(".mask").hide() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    定位图标消失
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/   
    $(".location").hide() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    关掉定时器
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/  
    for(key in this.timer) {
        window.clearInterval(this.timer[key]) ;
    }
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    圆圈图标消失
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/  
    $(".cycle").fadeTo(200, 0) ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
   计算结果关闭
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/  
    $(".memo").hide() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
   页面回到初始位置
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    //this.initPosition() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
   起点和终点值清空
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $("#startId").val("") ;
    $("#terminalId").val("") ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
改变起点终点位置
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
StationsController.prototype.changeHere=function(){
    $('.startEnd .metro span').click(function(event) {
        if($('.location.terminal').css('display')=='block' && $('.location.start').css('display')=='block'){
            var oneHtml=$(this).siblings('em').eq(0).html();
            var twoHtml=$(this).siblings('em').eq(1).html();
            $(this).siblings('em').eq(0).html(twoHtml);
            $(this).siblings('em').eq(1).html(oneHtml);
            if($('.location').eq(0).hasClass('start')){
                $('.location').eq(0).removeClass('start').addClass('terminal').siblings('.location').removeClass('terminal').addClass('start');
            }else{
                $('.location').eq(0).removeClass('terminal').addClass('start').siblings('.location').removeClass('start').addClass('terminal');
            }
        }
        event.stopPropagation();
    });
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
初始化native 跳转Url
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
StationsController.prototype.initNativeRedirectUrl = function(type,stationName) {
    var classSelf = this;
    var userAgent = navigator.userAgent || navigator.vendor || window.opera;
    if (userAgent.match(/iPad/i) || userAgent.match(/iPhone/i) || userAgent.match(/iPod/i)) {
        function setupWebViewJavascriptBridge(callback) {
            if (window.WebViewJavascriptBridge) {
                return callback(WebViewJavascriptBridge);
            }
            if (window.WVJBCallbacks) {
                return window.WVJBCallbacks.push(callback);
            }
            window.WVJBCallbacks = [callback];
            var WVJBIframe = document.createElement('iframe');
            WVJBIframe.style.display = 'none';
            WVJBIframe.src = 'wvjbscheme://__BRIDGE_LOADED__';
            document.documentElement.appendChild(WVJBIframe);
            setTimeout(function() {
                document.documentElement.removeChild(WVJBIframe)
            }, 0)
        }
        setupWebViewJavascriptBridge(function(bridge) {
            //本地处理IOS返回的数据开始
            bridge.registerHandler('response', function(data, responseCallback) { //IOS调用本地方法并传值过来，处理页面
                for(var i=0;i<$('.cycle').length;i++){
                    $('.cycle').eq(i).css('opacity','0.01');
                    if($('.cycle').eq(i).attr('data-name')==data.name){
                        $cycle=$('.cycle').eq(i);
                    }
                }
                if(data.type==0){
                    $cycle.trigger('click');
                    $("#setAsStart").trigger('click');
                    $('.context-menu').hide();
                    $('#childOne').children('i').html(stationName);
                    self.setKey(0);
                    self.navigate();
                }else if(data.type==1){
                    $cycle.trigger('click');
                    $("#setAsTerminal").trigger('click');
                    $('.context-menu').hide();
                    $('#childTwo').children('i').html(stationName);
                    self.setKey(1);
                    self.navigate();
                }
                //本地处理IOS返回的数据结束
                log('ObjC called testJavascriptHandler with', data)
                var responseData = { 'Javascript Says':'Right back atcha!' }
                log('JS responding with', responseData);
                responseCallback(responseData)
            })
            $(".metro em").on("click", function(e) {
                /*var _this = $(this);
                var type = _this.attr("data-type");
                var requestUrl = classSelf.nativeRedirectUrl + type;*/
                var requestData = {};
                if ($(this).hasClass('childOne')) {
                    bridge.callHandler('handleTxtFieldBeginEdit', {'type':'0'}, function(response) {
                        log('JS got response', response)
                    })
                } else if ($(this).hasClass('childTwo')) {
                    bridge.callHandler('handleTxtFieldBeginEdit', {'type':'1'}, function(response) {
                        log('JS got response', response)
                    })
                }
                

                e.preventDefault();
            });
        })
    } else if (userAgent.match(/Android/i)) {
        $(".metro em").click(function(event) {
                var redirectUrl = "";
                if ($(this).hasClass('childOne')) {
                    redirectUrl = classSelf.nativeRedirectUrl + '?type=0';
                } else if ($(this).hasClass('childTwo')) {
                    redirectUrl = classSelf.nativeRedirectUrl + '?type=1';
                }
                window.location.href= redirectUrl;
        });
    }
}
$(document).ready(function(){
    new StationsController ;    
});
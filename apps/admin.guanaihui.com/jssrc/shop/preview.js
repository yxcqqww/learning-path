/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 项目名称：admin.guanaihui.com
 2. 页面名称：shop/preview(商户->商户预览)
 3. 作者：俞晓晨(yuxiaochen@guanaihui.com)
 4. 备注：
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
function PreviewController() {
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
     继承于Controller基类
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    Controller.call(this);

    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
     发布
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.initIframe();

    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
     发布
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.publish();
}

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
初始化iframe
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
PreviewController.prototype.initIframe = function() {
    var $divHead = $("div.head")
    var $iframe = $("#iframepage");
    var height = $(window).height() - $divHead.height();

    $iframe.attr("height", height);
}


/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
发布
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
PreviewController.prototype.publish = function() {
    var classSelf = this;

    $(".btn").on("click", function() {
        var merchantId = $(this).data("id");
        var flag=$(this).data("flag");
        classSelf.confirm({
            content: "客官，您确认要发布么？",
            confirmInterface: function() {

                classSelf.request(classSelf.apiUrl.shop.online, {
                    "id": merchantId,
                    "isTjt":flag
                }, {
                    process: function(data) {
                        classSelf.tips("发布成功", 2, function() {
                            parent.window.opener.location.reload();
                            closeWP();
                        });
                    }
                });
            }
        });
    });


    function closeWP() {
        var Browser = navigator.appName;
        var indexB = Browser.indexOf('Explorer');

        if (indexB > 0) {
            var indexV = navigator.userAgent.indexOf('MSIE') + 5;
            var Version = navigator.userAgent.substring(indexV, indexV + 1);

            if (Version >= 7) {
                window.open('', '_self', '');
                window.close();
            } else if (Version == 6) {
                window.opener = null;
                window.close();
            } else {
                window.opener = '';
                window.close();
            }

        } else {
            window.close();
        }
    }
}



/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
类的初始化
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
$(document).ready(function() {
    new PreviewController;
});

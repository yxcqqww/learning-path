/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 项目名称：admin.guanaihui.com
 2. 页面名称：shop/branches(商户->门店列表)
 3. 作者：赵华刚(zhaohuagang@guanaihui.com)
 4. 备注：
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
function BranchesController() {
    this.quickPanel = $(".data-panel .quick-panel") ;    
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
     继承于Controller基类
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    Controller.call(this) ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    实例化条理化表格
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.instanceMethodizeTable() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    绑定事件
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.bind() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    点击路径导航中的商户管理链接
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.backCompanyList() ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
实例化合同面板
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
BranchesController.prototype.instanceQuickPanel = function() {
    var classSelf = this ;
    require([this.appStaticPrefix + "/shop/branch.min.js"], function(){        
        new BranchController({
            quickPanel : classSelf.quickPanel ,
            parentClass : classSelf
        }) ;
    }) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
事件绑定
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
BranchesController.prototype.bind = function() {
    var classSelf = this ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    新增按钮首先将保存的apiUrl赋予form的action，然后再将页面载入并实例化
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $(".data-panel .assistant .tools .add").click(function(){
        $(classSelf.quickPanel).attr("action", classSelf.apiUrl.shop.branches.add) ;
        classSelf.swapPanel(this) ;
    }) ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    每行里面设为总店和删除按钮以及编辑按钮
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $(".data-panel table tbody tr").each(function(){
        var id = $(this).attr("data-id") ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        编辑按钮首先将保存的apiUrl赋予form的action，然后再将页面载入并实例化
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        $(this).find(".edit").click(function(){
            $(classSelf.quickPanel).attr("action", classSelf.apiUrl.shop.branches.edit) ;
            classSelf.swapPanel(this) ;
        }) ;  
        $(this).find(".set-head").click(function(){
            var isTjt = $(this).attr("data-istjt") ;
            isTjt = (isTjt != undefined && isTjt === "true") ? true : false ;
            classSelf.setHead(id, isTjt) ;
        }) ;
        $(this).find(".remove").click(function(){
            classSelf.remove(id) ;
        }) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        搜索按钮
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        /*
        $(".data-panel .assistant .searcher button").click(function(){
            var keywords = $(".data-panel .assistant .searcher input[name='keywords']").val() ;            
            if(keywords) keywords = $.trim(keywords) ;
            if( ! keywords) return false ;
            require([classSelf.utilStaticPrefix + "/url.min.js"], function(){
                Url.updateSearchParam("nameQry", keywords) ;
                window.location.reload() ;
            }) ;
        }) ;
        */
    }) ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    全局的删除按钮
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $(".data-panel .assistant .tools .remove").click(function(){
        classSelf.remove($(".data-panel table input[name='methodize-table-checked-set']").val()) ;
    }) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
门店面板的弹出或者收起
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
BranchesController.prototype.swapPanel = function(handle) {
    var classSelf = this ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    先清空表单内容
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $(this.quickPanel).empty() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    然后再将页面异步加载进来并slideDown
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $(this.quickPanel).load($(handle).attr("data-href"), function(){
        classSelf.instanceQuickPanel() ;
        $(this).slideDown(200) ;

        //每次编辑始终滚动到页面顶部
        $(window).scrollTop(20);
    }) ;    
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
删除门店
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
BranchesController.prototype.remove = function(id) {
    var classSelf = this ;
    if( ! id ) {
        classSelf.tips("请先选择门店！", 2) ; 
        return false ;
    }
    this.confirm({
        "content" : "您确定要删除选中的门店吗？" ,
        "confirmInterface" : function() {
            classSelf.request(classSelf.apiUrl.shop.branches.delete, { "id" : id }, {
                process : function() {
                    classSelf.tips("删除门店成功！", 2, function(){
                        window.location.reload() ;
                    }) ;                    
                }
            }) ;
        } 
    }) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
设为总店
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
BranchesController.prototype.setHead = function(id, isTjt) {
    var classSelf = this ;    
    var apiUrl = isTjt ? this.apiUrl.shop.branches.setTjtHead : this.apiUrl.shop.branches.setHead ;
    this.request(apiUrl, { "id" : id }, {
        process : function() {
            classSelf.tips("设为总店成功！", 2, function(){
                window.location.reload() ;
            }) ;                    
        }
    }) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
类的初始化
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
$(document).ready(function() {
    new BranchesController;
});

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 项目名称：admin.guanaihui.com
 2. 页面名称：shop/gallery(商户->图库)
 3. 作者：赵华刚(zhaohuagang@guanaihui.com)
 4. 备注：
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
function GalleryController() {
    this.thumbIdSeparator = "," ;  //删除图片的时候，如果是多个，这里指定分隔符
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
     继承于Controller基类
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    Controller.call(this) ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    thumbnail类的实例化
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.instanceThumbnail() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    事件绑定
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.bind() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    点击路径导航中的商户管理链接
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.backCompanyList() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    自动跳转到cookie指定的帧
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.redirect() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    实例化tabs插件
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.initTabs() ;
    
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 thumbnail类的实例化
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
GalleryController.prototype.instanceThumbnail = function() {
    var classSelf = this ;
    require([this.appStaticPrefix + "/jquery.thumbnail.min.js"], function(){
        $(".thumbnail-preview .thumb").thumbnail({
            onDelete : function(thumbId){
                classSelf.removeThumbnail(thumbId, $(".data-panel .tabs .tabs-handle li.on").attr("data-category")) ;
            }
        }) ;
    }) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 事件绑定
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
GalleryController.prototype.bind = function() {
    var classSelf = this ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    全选
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $(".data-panel .assistant .select-all").click(function(){
        classSelf.selectAll(this) ;
    }) ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    保存顺序按钮
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $(".data-panel .assistant .save-sequence").click(function(){
        classSelf.saveSequence() ;
    }) ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    删除所选
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $(".data-panel .assistant .remove").click(function(){
        var thumbIdArray = new Array ;
        $(".tabs .tabs-frame:visible .thumb").each(function(){
            if($(this).find(".handle:visible").size() > 0) thumbIdArray.push($(this).find("img").attr("data-id")) ;
        }) ;
        var thumbId = thumbIdArray.join(classSelf.thumbIdSeparator) ;
        if(thumbId === "") {
            classSelf.tips("请选择图片！", 2) ;
            return false ;
        }
        classSelf.removeThumbnail(thumbId, $(".data-panel .tabs .tabs-handle li.on").attr("data-category")) ;
    }) ;
    
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 全选
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
GalleryController.prototype.selectAll = function(handle) {
    var status = $(handle).attr("data-status") ;
    if(status === "false") {
        $(".data-panel .tabs .tabs-frame:visible .thumb .handle").show() ;
        $(handle).attr("data-status", "true").text("取消全选") ;
    }
    else {
        $(".data-panel .tabs .tabs-frame:visible .thumb .handle").hide() ;
        $(handle).attr("data-status", "false").text("全选") ;
    }
    
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 删除指定id的图片，多个id用半角逗号隔开
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
GalleryController.prototype.removeThumbnail = function(thumbId, category) {
    var classSelf = this ;
    this.confirm({
        "content" : "您确定要删除图片吗？" ,
        "confirmInterface" : function() {
            classSelf.request(classSelf.apiUrl.shop.gallery.delete, { "imageIds" : thumbId , "profileType" : category}, {
                process : function() {
                    classSelf.tips("删除图片成功！", 2, function(){
                        var thumbIdArray = thumbId.split(classSelf.thumbIdSeparator) ;
                        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                        逐个删除图片
                        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                        $(".tabs .tabs-frame:visible .thumb").each(function(){
                            var id = $(this).find("img").attr("data-id").toString() ;
                            if($.inArray(id, thumbIdArray) != -1) $(this).remove() ;
                        }) ;
                        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                        最后刷新页面
                        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                        window.location.reload() ;
                    }) ;                    
                }
            }) ;
        } 
    }) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 删除指定id的图片，多个id用半角逗号隔开
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
GalleryController.prototype.saveSequence = function() {
    if($(".tabs .tabs-frame:visible .thumb").size() === 0) {
        this.tips("连图片都没有了，还有个毛的顺序啊！", 2) ;
        return false ;
    }
    var classSelf = this ;
    var sequenceArray = new Array ;   
    $(".tabs .tabs-frame:visible .thumb").each(function(index, element){
        sequenceArray.push($(element).find("img").attr("data-id")) ;
    }) ;    
    this.request(this.apiUrl.shop.gallery.sequence, {"idOrderList" : sequenceArray.join(",")}, {
        process : function() {
            classSelf.tips("保存图片顺序成功！", 2, function(){
                window.location.reload() ;
            }) ;
        }
    }) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
实例化多文件上传组件：uploadify
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
GalleryController.prototype.initUploadify = function() {
    var classSelf = this ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    先将原先的上传句柄干掉，免得重复实例化插件混淆不清
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $(".data-panel .assistant .file-uploader").empty() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    重新再创建一个上传句柄并贴到相应位置
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $(".data-panel .assistant .file-uploader").append("<div id=\"queue\" data-amount-successful=\"0\" data-amount-errored=\"0\" data-related-successful=\"0\"></div>") ;
    var $fileUploader = $(document.createElement("INPUT")).attr("id", "fileUploader").attr("type", "file").attr("name", "files").attr("multiple", true) ;
    $(".data-panel .assistant .file-uploader").append($fileUploader) ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    然后再实例化插件
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    require([this.utilStaticPrefix + "/uploadify/jquery.uploadify.min.js"], function(){        
        $("#fileUploader").uploadify({
            buttonText : " + 添加当前类别图片" ,   //按钮上的文字内容            
            height  : 34,  //按钮的高度
            fileObjName : "files" ,  //文件域的name属性值
            fileSizeLimit : "1024KB" ,  //文件大小最大限制
            fileTypeExts : "*.jpg;*.jpeg;*.png" ,
            formData : {"category" :  $(".data-panel .tabs .tabs-handle li.on").attr("data-category")} ,
            swf : "/static/uploadify/uploadify.swf" ,
            uploader  : classSelf.apiUrl.attachment.upload ,  //上传处理接口url            
            uploadLimit : 9 , //最多上传几个图片
            removeTimeout : 1 ,  // 	如果设置了任务完成后自动从队列中移除，则可以规定从完成到被移除的时间间隔。
            width  : 150 ,  //按钮的宽度
            onQueueComplete : function(queueData){
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
               将上传成功和上传失败图片数量记录在<div id="queue"></div>这个节点上
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                $("#queue").attr("data-amount-successful", queueData.uploadsSuccessful).attr("data-amount-errored", queueData.uploadsErrored) ;                
            } ,
            onUploadSuccess : function(file, data, response) {
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
               注意，onUploadSuccess是每个图片成功上传都要触发一次！
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                var data = $.parseJSON(data) ;
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                首先组织传递给接口的数据
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                var formData = {} ;
                formData.companyId = $(".data-panel .tabs input[name='companyId']").val() ;
                formData.profileType = $(".data-panel .tabs .tabs-handle li.on").attr("data-category") ;
                var fileUrlListArray = new Array ;
                $(data.result).each(function(){
                    fileUrlListArray.push(this.url) ;
                }) ;             
                formData.fileUrlList = fileUrlListArray.join(",") ;                
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                再发起第二次请求
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                classSelf.request(classSelf.apiUrl.shop.gallery.classify, formData, {
                    loadingTips : true ,
                    process : function(data){
                        var relatedSuccessfulAmount = parseInt($("#queue").attr("data-related-successful"), 10) ;
                        $("#queue").attr("data-related-successful", relatedSuccessfulAmount + 1) ;
                        if(parseInt($("#queue").attr("data-related-successful"), 10) === parseInt($("#queue").attr("data-amount-successful"), 10)) {
                            classSelf.tips($("#queue").attr("data-amount-successful") + " 张图片上传成功；" + $("#queue").attr("data-amount-errored") + " 张图片上传失败！", 3, function(){
                                window.location.reload() ;
                            }) ; 
                        }                                               
                    } 
                }) ;
            }
        }) ;      
       
    }) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
实例化tabs插件
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
GalleryController.prototype.initTabs = function() {
    var classSelf = this ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    实例化tabs，这里为什么要用click这个eventType?在删除图片的时候要根据当前tabs-frame选中的标识来删除，其他tabs-frame中哪怕选中了图片，点击删除
    的时候他们不会躺枪，如果用mouseover就怕在删除取id的刹那切换了tabs-frame
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.swapTabs({ 
        eventType : "click" , 
        effect : "fadeIn" , 
        duration : 100 , 
        onSwitch : function(index){
            var galleryCategory = $(".data-panel .tabs .tabs-handle li.on").attr("data-category") ;
            var $saveSequenceBtn = $(".data-panel .assistant .save-sequence") ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            重新初始化uploadify
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            classSelf.initUploadify() ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            把图库当前应该在哪个TAB上记录在cookie中，方面页面重载的时候定位
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $.cookie(classSelf.cookieKeyConf.shop.gallery.category, galleryCategory, {
                expires : classSelf.cookieExpires ,
                path : "/",
                domain : classSelf.cookieDomain
            }) ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            根据tabs-handle的data-category属性的值来决定顺序状态的按钮是否显示
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            if(galleryCategory === "AppLogo" || galleryCategory === "Thumbnail") $saveSequenceBtn.hide(100) ;
            else $saveSequenceBtn.show(100) ;
        }
    }) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
自动跳转到指定的cookie值的z帧
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
GalleryController.prototype.redirect = function(){
    var classSelf = this ;
    $(".data-panel .tabs .tabs-handle li").each(function(){
        if($(this).attr("data-category") === $.cookie(classSelf.cookieKeyConf.shop.gallery.category)) $(this).addClass("on") ;
    }) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
类的初始化
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
$(document).ready(function() {
    new GalleryController ;
});

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 项目名称：admin.guanaihui.com
 2. 页面名称：shop/products(机构->服务列表)
 3. 作者：赵华刚(zhaohuagang@guanaihui.com)
 4. 备注：
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
function ProductsController() {
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
     继承于Controller基类
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    Controller.call(this);
    
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    实例化条理化表格
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.instanceMethodizeTable();
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    实例化bootstrap-switch
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.instanceSwitch();
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    实例化dialog
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.instanceDialog();
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    绑定事件
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.bind();
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    点击路径导航中的机构管理链接
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.backCompanyList();
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
实例化bootstrap-switch
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
ProductsController.prototype.instanceSwitch = function() {
    var classSelf = this;
    require([this.bootstrapStaticPrefix + "/plugins/bootstrap-switch/dist/js/bootstrap-switch.min.js"], function() {
        var $handle = $(".data-panel .assistant .filter-bar input[type='checkbox']");
        $handle.bootstrapSwitch({
            onText: "是",
            offText: "否",
            size: "small"
        });
        $handle.on("switchChange.bootstrapSwitch", function(event, state) {
            classSelf.redirect(state);
        });
    });
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
根据是否只显示上线服务来跳转服务列表页面
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
ProductsController.prototype.redirect = function(state) {
    require([this.utilStaticPrefix + "/url.min.js"], function() {
        Url.updateSearchParam("online", state);
        window.location.reload();
    });
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
实例化dialog
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
ProductsController.prototype.instanceDialog = function() {
    var classSelf = this;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    所有dialog句柄点击弹出目标页面
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $(".dialog-handle").click(function() {
        var id = $(this).attr("data-dialog-id");
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        判断是哪种操作，来选择给form不同的action
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var action = "";
        if ($(this).hasClass("add")) action = classSelf.apiUrl.shop.products.add;
        else if ($(this).hasClass("edit")) action = classSelf.apiUrl.shop.products.edit;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        打开dialog
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        classSelf.dialog({
            "id": id,
            "url": $(this).attr("data-href"),
            "dimension": "lg"
        });
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        服务dialog实例化后要执行的任务
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        $("#" + id).on("loaded.bs.modal", function(e) {
            $("#" + id + " form").attr("action", action);
            require([classSelf.appStaticPrefix+"/shop/product.min.js"], function() {
                new ProductController({
                    productPanel: $("#" + id),
                    parentClass: classSelf
                });
            });
        });
    });
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
事件绑定
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
ProductsController.prototype.bind = function() {
    var classSelf = this;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    删除所选按钮
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $(".data-panel .assistant .tools .remove").click(function() {
        classSelf.remove($(".data-panel table input[name='methodize-table-checked-set']").val(),$(".assistant .searcher input[name='companyId']").val());
    });
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    上线所选按钮
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $(".data-panel .assistant .tools .release").click(function() {
        classSelf.release($(".data-panel table input[name='methodize-table-checked-set']").val());
    });
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    下线所选按钮
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $(".data-panel .assistant .tools .offline").click(function() {
        classSelf.offline($(".data-panel table input[name='methodize-table-checked-set']").val());
    });
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    每行里面设为总店和删除按钮
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $(".data-panel table tbody tr").each(function() {
        var id = $(this).attr("data-id");
        var companyId = $(".assistant .searcher input[name='companyId']").val();
        $(this).find(".offline").click(function() {
            classSelf.offline(id);
        });
        $(this).find(".remove").click(function() {
            classSelf.remove(id, companyId);
        });
        $(this).find(".release").click(function() {
            classSelf.release(id);
        });
    });

};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
删除服务
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
ProductsController.prototype.remove = function(id, companyId) {
    var classSelf = this;
    if (!id) {
        classSelf.tips("请先选择服务！", 2);
        return false;
    }
    classSelf.confirm({
        "content": "您确定要删除选中的服务吗？",
        "confirmInterface": function() {
            classSelf.request(classSelf.apiUrl.shop.products.delete, {
                "id": id,
                "companyId":companyId,
                "hasChecked": false
            }, {
                process: function(data) {
                    if (!data.result) {
                        classSelf.tips("删除服务成功！", 2, function() {
                            window.location.reload();
                        });
                    }
                    //如果校验不成功，这里需要弹出框需要用户确认是否需要删除
                    if (data.result && data.result.toString() === "1001") {
                        classSelf.confirm({ 
                            "content": "该服务属于营销推荐服务，如果下线会对展示造成影响，您确认要删除吗?",
                            "confirmInterface": function() {
                                classSelf.request(classSelf.apiUrl.shop.products.delete, {
                                    "id": id,
                                    "companyId":companyId,
                                    "hasChecked": true
                                }, {
                                    process: function() {
                                        classSelf.tips("删除服务成功！", 2, function() {
                                            window.location.reload();
                                        });
                                    }
                                });
                            }
                        });
                    }

                }
            });
        }
    });
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
上线
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
ProductsController.prototype.release = function(id) {
    if (!id) {
        this.tips("请先选择服务！", 2);
        return false;
    }
    var classSelf = this;
    this.request(this.apiUrl.shop.products.release, {
        "id": id
    }, {
        process: function() {
            classSelf.tips("上线服务成功！", 2, function() {
                window.location.reload();
            });
        }
    });
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
下线
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
ProductsController.prototype.offline = function(id) {
    if (!id) {
        this.tips("请先选择服务！", 2);
        return false;
    }
    var classSelf = this;
    classSelf.request(classSelf.apiUrl.shop.products.offline, {
        "id": id,
        "hasChecked": false
    }, {
        process: function(data) {
            if (!data.result) {
                classSelf.tips("下线服务成功！", 2, function() {
                    window.location.reload();
                });
            }
            //如果校验不成功，这里需要弹出框需要用户确认是否需要下线
            if (data.result && data.result.toString() === "1001") {
                classSelf.confirm({
                    "content": "该服务属于营销推荐机构/服务，如果下线会对展示造成影响，您确认要下线吗?",
                    "confirmInterface": function() {
                        classSelf.request(classSelf.apiUrl.shop.products.offline, {
                            "id": id,
                            "hasChecked": true
                        }, {
                            process: function() {
                                classSelf.tips("下线服务成功！", 2, function() {
                                    window.location.reload();
                                });
                            }
                        });
                    }
                });
            }
        }
    });
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
类的初始化
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
$(document).ready(function() {
    new ProductsController;
});

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 项目名称：admin.guanaihui.com
 2. 页面名称：shop/contract(商户->合同编辑面板)
 3. 作者：赵华刚(zhaohuagang@guanaihui.com)
 4. 备注：
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
function SelectUsersController(params) {    
    this.usersPanel = params.usersPanel ; 
    this.parentClass = params.parentClass ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    树形菜单容器
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    //this.treeContainer = $("#organizeTreeContainer") ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    树形菜单配置项
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    /*
    this.settings = {
        view : {
            selectedMulti : false ,  //设置树形菜单是否可以多选
            showIcon : false ,  //设置树形菜单是否显示图标
            showLine : true ,  //设置树形菜单是否显示线条            
            dblClickExpand : false ,  //设置双击节点的时候是否展开子菜单
            expandSpeed : "normal" ,  //设置节点展开、折叠时的动画速度
            nameIsHTML : true  //设置name树形是否支持html
        } ,
        edit : {
            drag : {
                isCopy  : false ,
                isMove  : true  //连同上面的isCopy属性设置所有的拖拽操作都是移动，不会有复制的情况                
            } ,
            enable : true ,
            showRemoveBtn : false ,
            showRenameBtn : false ,
            removeTitle : "移除" ,
            renameTitle : "重命名"
        } ,        
        callback : {           
            //onDrop : onDrop ,            
            //onClick : onClick
        }
    } ;
    */
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    最多可以选择多少个
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/    
    this.maximum = (params === null || params.maximum === null || params.maximum === undefined) ? 1 : params.maximum ;  
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    选中以后的结果如果是多选，这里定义分隔符
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/   
    this.resultSeparator = (params === null || params.resultSeparator === null || params.resultSeparator === undefined) ? "," : params.resultSeparator ;  
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    最近选择的联系人最多记忆多少个，前面自动被后面覆盖
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.memoryCapacity = (params === null || params.memoryCapacity === null || params.memoryCapacity === undefined) ? 8 : params.memoryCapacity ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    选择好以后的接口方法，注意这个接口方法有两个参数，第一个参数为id字符串，第二个参数为名称字符串
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.onSelected = (params === null || params.onSelected === null || params.onSelected === undefined) ? null : params.onSelected ;    
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    实例化tabs
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/            
    this.instanceTabs() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    读取cookie里面最近选中的人数据并写入到页面上
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.readMemory() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    先清除掉结果
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/ 
    this.empty() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    绑定事件
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/ 
    this.bind() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    初始化树
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    //this.initTree() ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
实例化tabs
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
SelectUsersController.prototype.instanceTabs = function() {
    var classSelf = this ;
    require([this.parentClass.utilStaticPrefix + "/jquery.tabs.min.js"], function(){                
        $(classSelf.usersPanel).find(".tabs").tabs({
            eventType : "click" ,
            effect : "fadeIn" ,
            duration : 200
        }) ;
    }) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
清空结果
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
SelectUsersController.prototype.empty = function() {
    $(this.usersPanel).find(".result-panel .result-scope").empty() ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
事件绑定
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
SelectUsersController.prototype.bind = function() {
    var classSelf = this ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    字母索引
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/ 
    $(this.usersPanel).find(".filter-panel .indexes a").click(function(){
        $(classSelf.usersPanel).find(".filter-panel .indexes a").removeClass("on") ;
        $(this).addClass("on") ;
        classSelf.letterIndex($(this).text()) ;
    }) ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    清空选择连接事件绑定
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/ 
    $(this.usersPanel).find(".result-panel .empty").click(function(){
        classSelf.empty() ;
    }) ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    从左边加到右边
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/ 
    $(this.usersPanel).find(".filter-panel .result-scope a").on("click", function(){
        classSelf.select(this) ;
    }) ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    我选好了按钮
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/ 
    $(this.usersPanel).find(".modal-footer button[type='submit']").on("click", function(){
        classSelf.confirm() ;
    }) ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    输入关键词对结果进行过滤
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $(this.usersPanel).find(".filter-form button").on("click", function(){
        var keywords = $(classSelf.usersPanel).find(".filter-form input[name='keywords']").val() ;
        var $users = $(classSelf.usersPanel).find(".content .tabs .all-frame .result-scope a")
        if(keywords) keywords = $.trim(keywords) ;
        if( ! keywords) $users.slideDown(100) ;
        else {
            $users.each(function(){
                var username = $(this).find(".username").text() ;
                if(username.indexOf(keywords) != -1) $(this).slideDown(100) ;
                else $(this).slideUp(100) ;
            }) ;
        }
    }) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
初始化树
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
SelectUsersController.prototype.initTree = function() {
    var classSelf = this ;
    require([       
        this.parentClass.utilStaticPrefix + "/ztree/js/jquery.ztree.exedit-3.5.js",
        this.parentClass.utilStaticPrefix + "/ztree/js/jquery.ztree.excheck-3.5.js"
    ], function(){
        var tree = $.fn.zTree.init(classSelf.treeContainer, classSelf.settings, organizeTreeNodes) ;
    }) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
读取cookie里面最近选中的人数据并写入到页面上
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
SelectUsersController.prototype.readMemory = function() {
    var classSelf = this ;
    var $recentlySelectedContainer = $(this.usersPanel).find(".filter-panel .recently-frame") ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    清空最近选择的人员容器
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $recentlySelectedContainer.empty() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    如果cookie中没有值就直接返回
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    var selectedUsersRecently = $.cookie(this.parentClass.cookieKeyConf.public.selectUsers.selectedRecently) ;
    if( ! selectedUsersRecently) return ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    数据分析并绘制节点
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    var surArray = selectedUsersRecently.split("&") ;
    $(surArray).each(function(){
        var user = this.split("|") ;
        var $user = $(document.createElement("A")).attr("href", "javascript:void(0);").attr("data-id", user[0]).attr("data-fp", user[1]).append("<span class=\"position\">" + user[3] + "</span>").append("<img src=\"" + classSelf.parentClass.staticDomain + "/apps/admin.guanaihui.com/css/images/default-portrait.jpg\" class=\"img-circle\">").append("<span class=\"username\">" + user[2] + "</span>") ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        这里不需要绑定事件，后面会统一绑定
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        $recentlySelectedContainer.append($user) ;
    }) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
字母过滤
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
SelectUsersController.prototype.letterIndex = function(letter) {
    if( ! letter) {
        $(this.usersPanel).find(".filter-panel .all-frame .result-scope a").fadeIn(100) ;
        return ;
    }
    letter = $.trim(letter).toLowerCase() ;
    $(this.usersPanel).find(".filter-panel .all-frame .result-scope a").each(function(){
        var fp = $.trim($(this).attr("data-fp")).toLowerCase() ;
        if(fp === letter) $(this).fadeIn(100) ;
        else $(this).fadeOut(100) ;
    }) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
选择人员到右边区域
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
SelectUsersController.prototype.select = function(user) {    
    var $existsUsers = $(this.usersPanel).find(".result-panel .result-scope a") ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    首先根据最大允许选择数来限定
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    if($existsUsers.size() >= this.maximum) {
        this.parentClass.tips("您最多可以选择" + this.maximum + "人！", 2) ;
        return false ;
    }
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    判断右边是否已经存在当前选中的人员
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    var id = $(user).attr("data-id").toString() ;    
    var repeatAmount = 0 ;        
    $existsUsers.each(function(){
        if(id === $(this).attr("data-id").toString()) {
            repeatAmount ++ ;
            return false ;
        }
    }) ;
    if(repeatAmount > 0) {
        this.parentClass.tips("已经在选择好的人员列表中！", 2) ;
        return false ;
    }
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    判断右边是否已经存在当前选中的人员
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    var $duplicate = $(user).clone() ;
    var $remove = $(document.createElement("SPAN")).addClass("remove").append("<i class=\"iconfont icon-shanchu1\"></i>") ;
    $remove.click(function(){
        $duplicate.remove() ;
    }) ;
    $duplicate.prepend($remove) ;
    $duplicate.hover(function(){
        $remove.fadeIn(100) ;
    }, function(){
        $remove.fadeOut(100) ;
    }) ;
    $(this.usersPanel).find(".result-panel .result-scope").append($duplicate) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
点击[我选好了]按钮后要把结果集记录在cookie里面，方便实现最近选择的人员功能，并将相关人员名称及ID填入输入框内
为了尽量减小cookie体积，cookie存放格式：id|fp|name|position&id|fp|name|position，解释如下：
@id : 人员ID
@fp : 首拼
@name : 名称
@position : 职位或者角色
属性之间用竖线分割，多个人员用&分割
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
SelectUsersController.prototype.memory = function() {
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    取到先前cookie中存在的选中的人员并拆分成数组
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    var $existsUsers = $(this.usersPanel).find(".result-panel .result-scope a") ;
    var selectedUsersRecently = $.cookie(this.parentClass.cookieKeyConf.public.selectUsers.selectedRecently) ;
    var surArray = new Array ;
    if(selectedUsersRecently) surArray = selectedUsersRecently.split("&") ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    吧现在选好的人员数据组织成数组
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    var sunArray = new Array ;
    $existsUsers.each(function(){
        sunArray.push($(this).attr("data-id") + "|" + $(this).attr("data-fp") + "|" + $.trim($(this).find(".username").text()) + "|" + $.trim($(this).find(".position").text().toString())) ;
    }) ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
   插入到前面后整体裁剪到指定数量
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    sunArray.concat(surArray).slice(0, this.memoryCapacity) ;
    $.cookie(this.parentClass.cookieKeyConf.public.selectUsers.selectedRecently, sunArray.join("&"), {
        expires : this.parentClass.cookieExpires ,
        path : "/",
        domain : this.parentClass.cookieDomain
    }) ;
} ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
选中操作，包括记忆功能以及向指定的输入框内写值，其中后者用接口方法来实现
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
SelectUsersController.prototype.confirm = function() {
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    保存选中的数据到cookie
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.memory() ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    组织数据，执行接口方法
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    var $existsUsers = $(this.usersPanel).find(".result-panel .result-scope a") ;
    var idArray = new Array ;
    var nameArray = new Array ;
    $existsUsers.each(function(){
        idArray.push($(this).attr("data-id")) ;
        nameArray.push($.trim($(this).find(".username").text())) ;
    }) ;
    if(this.onSelected) this.onSelected(idArray.join(this.resultSeparator), nameArray.join(this.resultSeparator)) ;
} ;


/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 项目名称：admin.guanaihui.com
 2. 页面名称：console/login(登录)
 3. 作者：赵华刚(zhaohuagang@guanaihui.com)
 4. 备注：
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
function LoginController() {
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
     继承于Controller基类
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    Controller.call(this);
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    根据cookie值初始化用户名输入框的值
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.initControlValue();
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    实例化bootstrap-switch
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.instanceSwitch();
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    登录的异步处理
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.submitForm();
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    密码框获取焦点的时候改成password类型
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.changePasswordType();
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    页面初始化时第一个输入框获取焦点
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.inputFocus();
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
实例化bootstrap-switch
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
LoginController.prototype.instanceSwitch = function() {
    var classSelf = this;
    require([this.bootstrapStaticPrefix + "/plugins/bootstrap-switch/dist/js/bootstrap-switch.min.js"], function() {
        var $handle = $("#rememberMeSwitcher");
        $handle.bootstrapSwitch({
            onText: "是",
            offText: "否"
        });
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        根据是否记住用户名的cookie值来决定这个切换到哪种state
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var initState = $.cookie(classSelf.cookieKeyConf.system.rememberMe) ? true : false;
        $handle.bootstrapSwitch("state", initState);
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        切换的时候改变隐藏域的值
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        $handle.on('switchChange.bootstrapSwitch', function(event, state) {
            $("input[name='rememberMe']").val(state);
        });
    });
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
密码框获取焦点的时候改成password类型
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
LoginController.prototype.changePasswordType = function() {
    $("input[name='password']").focus(function() {
        $(this).attr("type", "password");
    });
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
页面初始化时第一个输入框获取焦点
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
LoginController.prototype.inputFocus = function() {
    $("input")[0].focus();
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
根据cookie初始化控件的值
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
LoginController.prototype.initControlValue = function() {
    var username = $.cookie(this.cookieKeyConf.system.rememberMe) ? $.cookie(this.cookieKeyConf.system.username) : "";
    var rememberMe = $.cookie(this.cookieKeyConf.system.rememberMe) ? "true" : "false";
    $("input[name='username']").val(username);
    $("input[name='rememberMe']").val(rememberMe);
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
登录的异步处理
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
LoginController.prototype.submitForm = function() {
    var classSelf = this;
    require([this.utilStaticPrefix + "/jquery.asyncsubmit.min.js"], function() {
        $("form").asyncsubmit({
            apiUrl: classSelf.apiUrl.system.login,
            utilStaticPrefix: classSelf.utilStaticPrefix,
            dataType: classSelf.apiDataType,
            onSavingInterface: function() {
                classSelf.tips("正在进行处理，请稍等...");
            },
            onErrorInterface: function() {
                classSelf.tips("请求失败，请检查您的接口！", 2);
            },
            onSuccessInterface: function(result) {
                var rememberMe = $("input[name='rememberMe']").val();
                var username = (rememberMe === "true") ? $("input[name='username']").val() : null;
                var rememberMeOrNot = (rememberMe === "true") ? "true" : null;
                var cookieConf = {
                    expires: classSelf.cookieExpires,
                    path: "/",
                    domain: classSelf.cookieDomain
                };
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                根据情况设置cookie或者删除cookie
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                $.cookie(classSelf.cookieKeyConf.system.username, username, cookieConf);
                $.cookie(classSelf.cookieKeyConf.system.rememberMe, rememberMeOrNot, cookieConf);
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                最后跳转到指定的首页
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                window.location.href = classSelf.homeUrl;
            },
            onExceptionInterface: function(message) {
                classSelf.tips("<span class=\"text-danger\">" + message + "</span>", 5);
            }
        });
    });
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
类的初始化
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
$(document).ready(function() {
    new LoginController;
});

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 项目名称：www.guanaihui.com
 2. 页面名称：booking(预约页面)
 3. 作者：尹芹(yinqin@guanaihui.com)
 4. 备注：
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
function IndexController() {
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
     继承于Controller基类
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    Controller.call(this);
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    是否需要header
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.toggleHeader();
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
     初始化日历
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.dateSelected();
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
     选择门店
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.storeSelected();
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
     预约人数
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.reserveNumListener();
};

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
是否需要header，url跟参数header false不显示 true显示
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
IndexController.prototype.toggleHeader = function() {
    require([this.utilStaticPrefix + "/url/url.min.js"], function() {
        var urlParam = $.url('?');
        if (urlParam && 'header' in urlParam) {
            urlParam.header === 'true' ? $('header').show() : $('header').hide();
        }
    })
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
初始化日历
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
IndexController.prototype.dateSelected = function() {
    var classSelf = this;
    require([
        this.appStaticPrefix + '/booking/select-date.min.js',
        this.utilStaticPrefix + "/url/url.min.js"
    ], function() {
        /*********渲染日历*****************/
        $("[name='myDate']").each(function(i, item) {
            $(item).dateShow();
        });
        /*********根据url回显时间*****************/
        var urlParam = $.url('?'),
            month = "",
            showdate = "",
            index = 1;
        if (urlParam && 'myDate' in urlParam && urlParam.myDate) {
            showdate = urlParam.myDate;
            month = urlParam.myDate.substr(0, 7);
            index = $("tbody[month='" + month + "']").index();
            $("td").removeClass("on").find("span").removeClass("active");
            $("td[data-date='" + showdate + "']").addClass("on").find("span").addClass("active");
            if (index == 2) {
                $(".date-tool .next").click();
            }
        }
        /*********根据url回显已选择的门店*****************/
        if (urlParam && 'storeId' in urlParam && urlParam.storeId) {
            $("#storeId").val(urlParam.storeId);
        }
        /*********将已选的时间放到hidden表单里*****************/
        $("#myDate").val($("td.on").attr("data-date"));
    });
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
选择门店
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
IndexController.prototype.storeSelected = function() {
    var classSelf = this;
    $(".select-store").click(function() {
        var _this = $(this),
            myDate = $("td.on").attr("data-date");
        myDate ? window.location.href = "./choose-store.html?myDate=" + myDate : window.location.href = "./chooseStore.html";
    });
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
预约人数
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
IndexController.prototype.reserveNumListener = function() {
    var classSelf = this;
    $(".number .reduce").click(function() {
        var _this = $(this),
            _input = _this.siblings("input"),
            _inputVal = parseInt(_this.siblings("input").val());
        _inputVal > 1 ? _input.val(_inputVal - 1) : "";
    });
    $(".number .add").click(function() {
        var _this = $(this),
            _input = _this.siblings("input"),
            _inputVal = parseInt(_this.siblings("input").val());
        _inputVal < 9999 ? _input.val(_inputVal + 1) : "";
    });
    $(".number input").blur(function() {
        var _this = $(this),
            _val = _this.val();
        if (isNaN(_val) || parseInt(_val) > 9999) {
            classSelf.tips("修改数量失败,请重试！", 3);
            _this.val(_val);
        }
    });
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
类的初始化
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
$(document).ready(function() {
    new IndexController;
});

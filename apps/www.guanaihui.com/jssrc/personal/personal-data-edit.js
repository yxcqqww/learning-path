/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 项目名称：www.guanaihui.com
 2. 页面名称：personal-data-edit(个人中心-修改个人资料)
 3. 作者：俞晓晨(yuxiaochen@guanaihui.com)
 4. 备注：
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
function EditPersonal() {
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    继承于Controller基类
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    Controller.call(this);

    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    初始化日历控件
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.initDatePicker();
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    页面顶部全部服务分类下拉
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.servicesCategory();
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    初始化下拉框
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.initDropdown();
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    表单提交
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.submitForm();
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    top 栏
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.ajaxSet();

};
/*top栏获取一些东西*/
EditPersonal.prototype.ajaxSet=function(){
    $.ajaxSetup ({ 
        cache: false 
    });
    $(".topper-service").load('/personal/toper/count', function(data){
    });
}

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 初始化日历控件
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
EditPersonal.prototype.initDatePicker = function() {
    var dataStr = $('#datepicker').val();
    $('#datepicker').datepicker({
        format: 'yyyy/mm/dd',
        language: 'zh-CN',
        startdate: dataStr,
        autoclose: true
    });

    $('#datepicker').on("changeDate", function() {
        $('#hiddenDate').val(
            $('#datepicker').datepicker('getFormattedDate')
        );
    });
}

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 初始化下拉框
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
EditPersonal.prototype.initDropdown = function() {
    var classSelf = this;

    var province = $("#hd_defaultProvince").val();
    var city = $("#hd_defaultCity").val();

    require([classSelf.utilStaticPrefix + "/cascadeSelect/jquery.cascadeselect.min.js"], function() {
        $("#cityList").cascadeSelect({
            url: "/personal/area/data",
            defaultVals: [province, city],
            nameAttrs: ["personLongestLivingProvince", "personLongestLivingCity"],
            classAttrs: ["form-control input-sm", "form-control input-sm"],
            crossDomain: true,
            level: 2
        });
    });
}

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 表单提交
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
EditPersonal.prototype.submitForm = function() {
    var classSelf = this;

    require([classSelf.utilStaticPrefix + '/jquery.asyncsubmit.js'], function() {
        $('#personalForm').asyncsubmit({
            dataType: classSelf.apiDataType,
            scroll: false,
            utilStaticPrefix: classSelf.utilStaticPrefix,
            apiUrl: classSelf.loginApiUrl,
            beforeSaveInterface: function() {

            },
            onSavingInterface: function() {

            },
            onErrorInterface: function() {
                classSelf.tips("请求失败，请检查您的接口！", 3);
            },
            onSuccessInterface: function(data) {
                window.location.href = "/personal/info";
            },
            onExceptionInterface: function(message) {
                classSelf.tips("<span class=\"text-danger\">" + message + "</span>", 5);
            }
        });
    });
}



/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 类的初始化
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
$(document).ready(function() {
    new EditPersonal;
});

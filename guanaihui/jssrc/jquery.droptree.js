/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 插件名称：droptree
 2. 插件描述：下拉选择树形菜单插件
 3. 版本：1.0
 4.  对其他插件的依赖：ztree和requireJs，还有字体图标的依赖
 5. 作者：zhaohuagang@guanaihui.com
 6. 未尽事宜：
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
(function($) {
    $.fn.droptree = function(options) {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        droptree加上对应的配置属性
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var opts = $.extend({}, $.fn.droptree.defaults, options);
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
         执行事件添加后返回
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        return this.each(function() {
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            绘制dom节点
             -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $.fn.droptree.generate(this, opts) ;
        });
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    绘制dom节点
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.droptree.generate = function(dropTree, opts) {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        绘制箭头部分dom节点
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var treeHandle = $(document.createElement("DIV")).addClass("tree-handle").append($(document.createElement("I")).addClass("iconfont icon-xiangxia2")) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        绘制选中的label容器部分dom节点，如果有初始化的值就将label放到容器下
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var selectedLabel = $(document.createElement("DIV")).addClass("selected-label") ;
        if(opts.initialLabelContainer) $(selectedLabel).text($(opts.initialLabelContainer).val()) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        绘制树形菜单容器部分dom节点
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var treeContainer = $(document.createElement("UL")).addClass("tree-container ztree").attr("id", opts.treeId) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        将绘制好的dom节点全部贴到容器下
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/        
        $(dropTree).append(treeHandle).append(selectedLabel).append(treeContainer).addClass("drop-tree") ;  
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        加载树形菜单
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        $.fn.droptree.loadTree(dropTree, opts) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        样式设置
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        if(opts.width) $(dropTree).css({ "width" : opts.width }) ;       
        $(treeContainer).css({ "left" : "-1px" , "width" : ($(dropTree).width() - 10) + "px" , "zIndex" : opts.zIndex }) ;  //为什么宽度减10 ？加了ztree这个class，这个class设置了padding : 5px ，为什么left : -1px ? 因为在父容器内，父容器有1像素边框，要对齐必须-1
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        事件处理
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        $(dropTree).click(function(event){
            $(treeContainer).css({ "visibility" : "visible" }) ;
            $(treeHandle).find("i").removeClass("icon-xiangxia2").addClass("icon-xiangshang3") ;
            event.stopPropagation() ;
        }) ;
        $(document).click(function(){
            $(treeContainer).css({ "visibility" : "hidden" }) ;
            $(treeHandle).find("i").addClass("icon-xiangxia2").removeClass("icon-xiangshang3") ;
        }) ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    加载树节点数据
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.droptree.loadTree = function(dropTree, opts) {
        require([
            "http://cdn08.ttpaicdn.com/ttpai/js/util/ztree/js/jquery.ztree.core-3.5.js",
            "http://cdn15.ttpaicdn.com/ttpai/js/util/ztree/js/jquery.ztree.excheck-3.5.js"
        ], function(){            
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            对树形菜单进行配置
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            var conf = {
                treeId : opts.treeId ,
                check : {
                    enable : opts.multiSelect ,
                    chkStyle : "checkbox"
                } ,
                data : {
                    simpleData: {
                        enable : true ,
                        pIdKey : "partentId"
                    }                    
                } ,
                view : {
                    showIcon : false
                } ,
                callback : {                    
                }
            } ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            根据是否多选来配置回调函数
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            if(opts.multiSelect) conf.callback.onCheck = function(event, treeId, treeNode) {
                //alert(treeNode.name + "选中状态：" + treeNode.checked) ;
                var selectedLabel = $(dropTree).find(".selected-label").text() ;
                var selectedLabelArray = selectedLabel ? selectedLabel.split(opts.separator) : new Array ;
                var selectedValue = $(opts.dataSaveInto).val() ;
                var selectedValueArray = selectedValue ? selectedValue.split(opts.separator) : new Array ;
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                如果是选中状态：如果先前已经选择了就啥也别做，如果没有，就加进去
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                if(treeNode.checked) {
                    if($.inArray(treeNode.name, selectedLabelArray) === -1) selectedLabelArray.push(treeNode.name) ;
                    if($.inArray(treeNode.id, selectedValueArray) === -1) selectedValueArray.push(treeNode.id) ;
                    $(dropTree).find(".selected-label").text(selectedLabelArray.join(opts.separator)) ;
                    $(opts.initialLabelContainer).val(selectedLabelArray.join(opts.separator)) ;
                    $(opts.dataSaveInto).val(selectedValueArray.join(opts.separator)) ;
                }
                else {
                    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                    如果是取消选中状态，如果先前有，就去掉，先前没有就啥也别做
                    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                    if($.inArray(treeNode.name, selectedLabelArray)  !== -1) {                       
                        var newSelectedLabelArray = new Array ;
                        var newSelectedValueArray = new Array ;
                        $.each(selectedLabelArray, function(key, element){
                            if(element !== treeNode.name) newSelectedLabelArray.push(element) ;
                        }) ;                        
                        $(dropTree).find(".selected-label").text(newSelectedLabelArray.join(opts.separator)) ;
                        $(opts.initialLabelContainer).val(newSelectedLabelArray.join(opts.separator)) ;
                        $.each(selectedValueArray, function(key, element){
                            if(element.toString() !== treeNode.id.toString()) newSelectedValueArray.push(element) ;
                        }) ;
                        $(opts.dataSaveInto).val(newSelectedValueArray.join(opts.separator)) ;
                    }
                                       
                }
            } ;
            else conf.callback.onClick = function(event, treeId, treeNode) {
                if(opts.multiSelect) return ;
                if(treeNode.isParent === true ) return ;
                $(dropTree).find(".selected-label").text(treeNode.name) ;
                $(opts.initialLabelContainer).val(treeNode.name) ;
                $(opts.dataSaveInto).val(treeNode.id) ;                
                $(dropTree).find(".tree-container").css({ "visibility" : "hidden" }) ;                
                $(dropTree).find(".tree-handle").find("i").addClass("icon-xiangxia2").removeClass("icon-xiangshang3") ;
                event.stopPropagation() ;
            } ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            最后实例化树形菜单
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $.fn.zTree.init($(dropTree).find(".tree-container"), conf, opts.sourceData) ;
        }) ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
     droptree默认配置
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.droptree.defaults = {       
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        droptree的宽度设置，比如："120px" ,默认为null，为null表示不给容器设置宽度
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        width : "100%" ,        
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        初始的选中标签值存放在哪个表单控件内(一般是隐藏域)
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        initialLabelContainer : null ,        
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        是否多选，默认为false，也就是显示radio，如果为true就是显示成checkbox
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        multiSelect : false ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        数据源
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        sourceData : null ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        保存选中的ID值的隐藏域的dom节点
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        dataSaveInto : null ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        选中的标签及值的分隔符，默认为半角逗号 ","
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        separator : "," ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        树形菜单容器的ID
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        treeId : "" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        树形菜单容器的zIndex的值
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        zIndex : 1000
    } ;
})(jQuery) ;
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
1. 插件名称：ajaxsave
2. 插件描述：表单以ajax方式提交
3. 版本：1.0
4.  对其他插件的依赖：验证控件来处理表单验证
5. 备注：    
6. 未尽事宜：
7. 作者：赵华刚(zhaohuagang@guanaihui.com)
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
(function($){
    $.fn.ajaxsave = function(options){		
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        将每个ajaxsave加上对应的配置属性
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var opts = $.extend({}, $.fn.ajaxsave.defaults, options);  
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        执行事件添加后返回
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        return this.each(function(){            
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            根据表单的class里面是否含有validate来判断是否需要验证
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            var validate = $(this).hasClass("validate");
            var form = this ;
            if(validate) {
                 require([
                    "http://cdn08.360guanai.com/guanaihui/js/util/validation/js/languages/jquery.validationEngine-zh_CN.js" ,
                    "http://cdn08.360guanai.com/guanaihui/js/util/validation/js/jquery.validationEngine.js"
                ], function(){
                    $(form).validationEngine({
                        promptPosition : opts.promptPosition ,
                        autoHidePrompt : true ,
                        autoHideDelay : 5000 ,
                        scroll : opts.scroll
                    }) ;
                }) ;
            }
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            根据表单的class里面是否含有validate来判断是否需要验证
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(opts.submitBtnSelector).click(function(){
                $(form).trigger("submit") ;
            }) ;
            $(this).submit(function(){                
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                先执行保存前的接口方法
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                if(opts.beforeSaveInterface) opts.beforeSaveInterface() ;  
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                再验证，如果通过再保存
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                if($(this).validationEngine('validate')) {                    
                    $.fn.ajaxsave.save(this, opts) ;                    
                }      
                return false;
            });
        });
    };
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    保存处理的方法
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.ajaxsave.save = function(form, opts) {   
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        参数获取：
        1. 提交处理的url从form标签的action属性中获取
        2. 请求是post还是get也是从form的method属性中获取
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var url = $(form).attr("action") ;        
        var method = ($(form).attr("method") === undefined) ? "GET" : $(form).attr("method").toUpperCase() ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        根据配置决定是否需要对表单所有价格类控件进行四舍五入处理
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        if(opts.priceRound) {
            $(form).find("." + opts.priceClassName).each(function(){
                var value = parseFloat($(this).val()).toFixed(opts.pricePrecision) ;
                $(this).val(value) ;
            }) ;
        }
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        执行过程中的接口方法
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/        
        if(opts.onSavingInterface) opts.onSavingInterface() ;        
         /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        发起ajax请求
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        try {
            $.ajax({
                url : url,
                data : $(form).serialize(),
                type : method,
                dataType : opts.dataType ,
                jsonpCallback:"callback",
                beforeSend: function(request) {
                    request.setRequestHeader("X-Requested-With", "XMLHttpRequest");
                } ,
                error : function(e) {
                    opts.onErrorInterface() ;
                } ,
                success : function(data){
                    if(data.code.toString() === "200") opts.onSuccessInterface(data.result) ;
                    else opts.onExceptionInterface(data.message) ;             
                }
            }); 
        }
        catch(e) {
            console.log("错误名称："+e.name+"\n错误描述："+e.message);
        }
    
    };
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    ajaxsave默认配置
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.ajaxsave.defaults = {	   
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        提交按钮选择器
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        submitBtnSelector : "input[type='submit']" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        保存前的接口方法
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        beforeSaveInterface : null ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        保存过程中的接口方法
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        onSavingInterface : null ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        请求接口出错的时候的接口方法
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        onErrorInterface : null ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        成功获取数据后的接口方法，这个方法中的唯一参数就是以结果json中的result这个key的内容
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        onSuccessInterface : null ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        成功获取数据但是出现异常后的接口方法，这个方法中的唯一参数就是以结果json中的message这个key的内容
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        onExceptionInterface : null ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        保存接口返回的数据类型，默认为jsonp
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        dataType : "jsonp" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        是否需要处理价格信息成保留两位小数
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        priceRound : true ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        价格表单控件的类名
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        priceClassName : "price-round" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        价格精度，就是价格小数位数，默认为2
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        pricePrecision : 2 ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        验证控件错误信息提示位置
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        promptPosition : "topLeft" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        验证控件错误信息提示的时候页面是否滚动
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        scroll : true
    };
})(jQuery) ;
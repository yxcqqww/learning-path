/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
1. 插件名称：lazyload
2. 插件描述：延迟加载图片
3. 版本：1.0
4. 原理：
    先将图片的真实地址缓存在一个自定义的属性(如 data-src )中，而src地址使用一个1×1的全透明的占位图片来代替，当然占位图片也可以是其他的图片。
    初始状态图片代码：<img src="images/placeholder.png"  data-src="images/realimg.jpg" />
    因为是使用javascript来加载图片，如果用户禁用了javascript，可以设置一个替代的方案。
    <img src="images/placeholder.png"  data-src="images/realimg.jpg" alt="" />
    <noscript><img src="images/realimg.jpg"  alt="" /></noscript>
    window事件触发时获取图片在页面中的位置并缓存，计算出可视区域，当图片的位置出现在可视区域中，将src的值替换成真实的地址并删除如data-src等占位符属性，此时图片就开始加载了。当所有的图片都加载完之后，将相应的触发事件卸载，避免重复操作引起的内存泄漏。
    将整个窗口看成是一个大容器，那么也可以在页面中设置一个小容器，在小容器中也同样可以实现图片的延迟加载。
    对于指定选择器的Dom的过滤有以下条件：
    1. 是否执行隐藏的Dom节点
    2. Dom节点是否img
    3. Dom节点是否存在指定的占位符属性
    如果用户按end键，就是直接滚动到页面最下面，就要将所有的图片执行加载。
5. 使用范例： 
    $(".lazy").lazyload() ;
6. 未尽事宜：每次触发器触发事件都要去重新过滤一遍Dom，这样性能不是太好。在2.0版本将解决这个问题
7. 作者：zhaohuagang@guanaihui.com
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
(function($){
    $.fn.lazyload = function(options) {
        var scopeNode = this ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        合并lazyload配置属性
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var opts = $.extend({}, $.fn.lazyload.defaults, options) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        $(document).ready的时候就要去触发一次批量加载
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        $(document).ready(function() {           
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            需要处理的图片清单
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            var imgObjectArray = $.fn.lazyload.filterCache(scopeNode, opts) ;            
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            开始批量加载图片
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $.fn.lazyload.batchLoad(imgObjectArray, opts) ;
        }) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        给window对象绑定事件
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        $(window).bind(opts.events, function(){           
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            需要处理的图片清单
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            var imgObjectArray = $.fn.lazyload.filterCache(scopeNode, opts) ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            如果需要延迟加载图片数量为0直接卸载事件
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/            
            if(imgObjectArray.length === 0) $(window).unbind(opts.events) ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            开始批量加载图片
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $.fn.lazyload.batchLoad(imgObjectArray, opts) ;         
        }) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        如果按下END键(请修改ENDkeyCode)，如果配置需要加载
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        $(document).bind("keyup", function(event){
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            需要处理的图片清单
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            var imgObjectArray = $.fn.lazyload.filterCache(scopeNode, opts) ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            如果按下的是END键就全部加载
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            if(event.which === 35) {
                $.each(imgObjectArray, function(index, imgObject){
                    $.fn.lazyload.load(imgObject.element, opts) ;                   
                }) ;
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                肯定是加载了所有，所以最后卸载事件
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                $(window).unbind(opts.events) ;
            }
        }) ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    根据指定触发器的滚动条位置来决定加载哪些图片
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.lazyload.batchLoad = function(imgObjectArray, opts) {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        滚动条的滚动距离
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var scrollTop =$(window).scrollTop() ;
        var scrollLeft =$(window).scrollLeft() ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        遍历dom节点，进行判断和加载
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        $.each(imgObjectArray, function(index, imgObject){
            var validTop = scrollTop + $(window).height() + opts.threshold ;
            var validLeft = scrollLeft + $(window).width() + opts.threshold ;            
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            进入射程的，载无赦
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/            
            if((opts.direction === "vertical" && validTop >= imgObject.top) || (opts.direction === "horizontal" && validLeft >= imgObject.left)) {                
                $.fn.lazyload.load(imgObject.element, opts) ;                                    
            }
        }) ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    对要处理的Dom对象进行过滤并缓存他们在页面上的位置
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.lazyload.filterCache = function(elements, opts) {
        var lazyImgArray = new Array ;
        $(elements).each(function(index, element){
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            如果元素不可见而且允许忽略就忽略
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            if( ! $(element).is(":visible") && opts.ignoreInvisible) return ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            如果不是图片就忽略
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            if(element.tagName != "IMG") return ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            如果Dom节点不存在指定的占位符属性就忽略
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            var dataAttr = $(element).attr(opts.dataAttr) ;
            if( ! dataAttr || dataAttr == "undefined") return ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            如果图片的src属性没有设置，将图片的src设置成占位符图片
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            var src = $(element).attr("src") ;
            if( ! src || src == "undefined") $(element).attr("src", opts.placeholder) ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            连同图片在页面上的坐标一起缓存起来
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            var offset = $(element).offset() ;
            lazyImgArray.push({ "index" : index , "element" : element , "left" : offset.left , "top" : offset.top }) ;
        }) ;
        return lazyImgArray ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    对图片的加载等处理，并按照指定效果进行显示
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.lazyload.load = function(element, opts) {
        $(element).hide() ;
        $(element).attr("src", $(element).attr(opts.dataAttr)).removeAttr(opts.dataAttr) ;
        eval("$(element)." + opts.effect + ";") ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    lazyload默认配置
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.lazyload.defaults = {       
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        触发events
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        events : "scroll.lazyload resize.lazyload" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        触发延迟加载的滚动的方向，比如是看垂直滚动还是横向滚动，值可以是：vertical | horizontal
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        direction : "vertical" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        按下键盘的END键的时候是否全部扫描并加载
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        endKeyScanAll : true ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        滚动条的offsetTop(offsetLeft)加上window的高度(宽度)离每个图片元素在页面上的top位置距离多少的时候开始触发图片的加载，如果threshold大于0，相当于滚动条还没有拉到图片位置的时候就开始加载
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        threshold : -50 ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        是否忽略哪些不可见的图片元素
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        ignoreInvisible : true ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        占位符属性，就是用什么属性来缓存src的值
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        dataAttr : "data-src" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        显示的效果，就是jQuery里面的方法名称，可以是：show | fadeIn | slideDown 加上延时
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        effect : "fadeIn(1000)" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        占位符图片
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        placeholder : "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC"
    } ;
})(jQuery) ;

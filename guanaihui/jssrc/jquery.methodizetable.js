/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 插件名称：methodizetable
 2. 插件描述：tag形式的复选框
 3. 版本：1.0
 4.  对其他插件的依赖：无
 5. 作者：zhaohuagang@guanaihui.com
 6. 未尽事宜：
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
(function($) {
    $.fn.methodizetable = function(options) {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        methodizetable加上对应的配置属性
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var opts = $.extend({}, $.fn.methodizetable.defaults, options);
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
         执行事件添加后返回
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        return this.each(function() {
            var table = this ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            初始化
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $.fn.methodizetable.init(this, opts) ;            
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            thead里面句柄的事件绑定
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/            
            $(this).find("thead .handle i").click(function(){
                
                var handle = this ;                
                $(table).find("tbody tr").each(function(){
                    $.fn.methodizetable.switchRowCheckedStatus(this, ! $(handle).hasClass("icon-18-checked"), opts) ;
                }) ;
                $(this).toggleClass("icon-18-checked").toggleClass("icon-18-unchecked") ;
                $.fn.methodizetable.union(table, opts) ;
            }) ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            tbody里面句柄的事件绑定
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(this).find("tbody tr").each(function(){
                var row = this ;
                $(this).find(".handle i").click(function(){
                    $.fn.methodizetable.switchRowCheckedStatus(row, ! $(this).hasClass("icon-18-checked"), opts) ;
                    var checked = $(table).find("tbody .handle .icon-18-checked").size() === $(table).find("tbody .handle .icon-18").size() ;
                    if(checked) $(table).find("thead .handle i").addClass("icon-18-checked").removeClass("icon-18-unchecked") ;
                    else $(table).find("thead .handle i").removeClass("icon-18-checked").addClass("icon-18-unchecked") ;                    
                    $.fn.methodizetable.union(table, opts) ;
                }) ;
            }) ;
        });
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
     初始化工作：    
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.methodizetable.init = function(table, opts) {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        1. 首先在thead中的句柄后面增加一个隐藏域，用来保存选中的句柄的值的集合
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        $(table).find("thead input[name='" + opts.handleName + "']").after($(document.createElement("INPUT")).attr("name", opts.dataSaveHiddenName).attr("type", "hidden")) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        2. 用相应的handle标签替换掉checkbox，并将tr的data-id同步到handle
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        $(table).find("tr").each(function(){
            var $originalHandle = $(this).find("input[name='" + opts.handleName + "']") ;
            var className = $originalHandle.is(":checked") ? "checked" : "unchecked" ;
            var $newHandle = $(document.createElement("I")).attr("data-id", $(this).attr("data-id")).addClass("icon-18 icon-18-" + className) ;
            $originalHandle.replaceWith($newHandle) ;
        }) ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
     选择/取消选择某行，参数：
    @row : 行的dom节点或者jQuery对象
    @status : 选中状态，值为true | false
    @opts : 配置选项
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.methodizetable.switchRowCheckedStatus = function(row, status, opts) {
        if($(row).find(".handle i").size() === 0) return ;        
        var $handle = $(row).find(".handle i") ;        
        if(status) $(row).addClass(opts.activeRowClassName) ;
        else $(row).removeClass(opts.activeRowClassName) ;        
        if(status) $handle.addClass("icon-18-checked").removeClass("icon-18-unchecked") ;
        else $handle.addClass("icon-18-unchecked").removeClass("icon-18-checked") ;
        $handle = null ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
     将所有选中的行句柄checkbox的值合并到隐藏域，参数：
    @table : 表格的dom节点或者jQuery对象
    @opts : 配置选项
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.methodizetable.union = function(table, opts) {
        var valueArray = new Array ;
        $(table).find("tbody .handle i").each(function(){
            if($(this).hasClass("icon-18-checked")) valueArray.push($(this).attr("data-id")) ;
        }) ;
        $(table).find("input[name='" + opts.dataSaveHiddenName + "']").val(valueArray.join(opts.separator)) ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
     methodizetable默认配置
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.methodizetable.defaults = {       
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        选中的行的class名称
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        activeRowClassName : "on" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        选中的行的checkbox的值的集合的分隔符
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        separator : "," ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        用来保存选中的句柄值的集合的隐藏域的name值
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        dataSaveHiddenName : "methodize-table-checked-set" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        句柄checkbox的name值
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        handleName : "row-handle"
    } ;
})(jQuery) ;
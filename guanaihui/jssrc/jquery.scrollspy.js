/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
1. 插件名称：scrollspy
2. 插件描述：滚动监听(比如页面滚动到某个位置，导航也跟着切换到相应位置的选项上面等)
3. 版本：1.0
4. 原理：    
5. 使用范例：  
    在句柄容器的每个想要实现监听的选项上添加诸如data-target的属性，值为鼠标滚动到某个容器位置时句柄为当前句柄这个容器的选择器
    在句柄容器上$(".nav").scrollspy() ;
    demo : 51autoimg/demo/api-usage/scrollspy.html
6. 未尽事宜：
7. 作者：zhaohuagang@guanaihui.com
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
(function($){
    $.fn.scrollspy = function(options) {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        合并scrollspy配置属性
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var opts = $.extend({}, $.fn.scrollspy.defaults, options) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        给每个容器元素绑定事件
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        return this.each(function(){            
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            取得导航句柄项
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            var handle = this ;
            var handleItems = $.fn.scrollspy.filter(this, opts) ;            
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            对页面的指定事件绑定
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/            
            $(window).bind(opts.events, function() {                
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
               遍历导航句柄项，根据配置决定是否进行句柄项的class变化
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/                  
                $.fn.scrollspy.iterativeDetect(handle, handleItems, opts) ;
            }) ;           
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            导航句柄点击的时候滚动到相应位置
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(handleItems).each(function(){
                $(this).click(function(){                   
                    $.fn.scrollspy.scrollTo($($(this).attr(opts.targetAttr)), opts) ;
                }) ;
            }) ;
        }) ;
    } ; 
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    遍历句柄，监听滚动来尝试改变句柄class
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.scrollspy.iterativeDetect = function(container, handleItems, opts) {        
        $(handleItems).each(function(){                    
            $.fn.scrollspy.detect(container, this, opts) ;
        }) ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    对句柄元素的过滤：
    如果没有定义目标锚点的属性及值，就去掉
    对于目标节点的位置缓存起来
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.scrollspy.filter = function(scope, opts) {
        var result = new Array ;
        $(scope).find(opts.handleSelector).each(function(index, element){
            var targetAttr = $(element).attr(opts.targetAttr) ;
            if(targetAttr === "undefined") return ;
            if($.trim(targetAttr) === "") return ;
            result.push(element) ;
            var position = $(targetAttr).position() ;
            $(targetAttr).attr("data-top", position.top).attr("data-left", position.left) ;
        }) ;        
        return result ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    容器根据配置滚动到指定对象的位置
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.scrollspy.scrollTo = function(target, opts) {
        var position = $(target).position() ;        
        var cssObject ;
        if(opts.direction === "vertical") cssObject = { scrollTop : position.top + "px"} ;
        else cssObject = { scrollLeft : position.left + "px"} ;        
        $("html,body").animate(cssObject, opts.scrollDuration) ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    根据页面滚动条位置决定导航句柄项哪个被active
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.scrollspy.detect = function(container, handleItem, opts) {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        取得句柄对应的目标锚点的位置及尺寸信息
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var top = parseInt($($(handleItem).attr(opts.targetAttr)).attr("data-top"), 10) ;
        var left = parseInt($($(handleItem).attr(opts.targetAttr)).attr("data-left"), 10) ;
        var height = $($(handleItem).attr(opts.targetAttr)).height() ;
        var width = $($(handleItem).attr(opts.targetAttr)).width() ;        
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        取得页面滚动条位置
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var scrollTop =$(window).scrollTop() ;
        var scrollLeft =$(window).scrollLeft() ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        如果满足条件，移除其他句柄项的active class，为自己加上这个class
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        if((opts.direction === "vertical" && scrollTop >= top && scrollTop <= (top + height)) || (opts.direction === "horizontal" && scrollLeft >= left && scrollLeft <= (left + width))) {            
            $(container).find(opts.handleSelector).removeClass(opts.handleActiveClass) ;
            $(handleItem).addClass(opts.handleActiveClass) ;
        }
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    scrollspy默认配置
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.scrollspy.defaults = {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        滚动方向，值可以是：vertical | horizontal
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        direction : "vertical" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        导航(句柄)选项active状态的class名称
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        handleActiveClass : "on" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        句柄选项选择器
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        handleSelector : "li" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        句柄选项上定义目标锚点的属性名称，这个属性的值应该是一个选择器对象
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        targetAttr : "data-target" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        滚动到指定位置所需要的时间
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        scrollDuration : 500 ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        触发监听的事件
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        events : "load.scrollspy scroll.scrollspy resize.scrollspy"    
    } ;
})(jQuery) ;

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 插件名称：popover
 2. 插件描述：弹出框
 3. 版本：1.0
 4.  对其他插件的依赖：无
 5. 作者：赵华刚(zhaohuagang@guanaihui.com)
 6. 未尽事宜：无
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
(function($) {
    $.fn.popover = function(options) {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        配置属性的扩展
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var opts = $.extend({}, $.fn.popover.defaults, options);
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
         执行事件添加后返回
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        return this.each(function() {
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            再创建popover的dom节点
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            var popover = $.fn.popover.create(opts) ;
            $("body").prepend(popover) ; 
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            首先取得句柄在浏览器窗口中的位置、大小等信息
             -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            var handle = opts.container ? opts.container : this ;
            var handleOffset = $(handle).offset() ;
            var handleWidth = $(handle).outerWidth() ;
            var handleHeight = $(handle).outerHeight() ;
            var popoverWidth = $(popover).outerWidth() ;             
            var popoverHeight = $(popover).outerHeight() ;            
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            计算要打开弹出框的位置
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            var left, top ;
            if (opts.placement === "top") {                        
                left = handleOffset.left - (popoverWidth - handleWidth) / 2 ;
                top = handleOffset.top - popoverHeight - 8 ;
            }
            else if (opts.placement === "right") {                
                left = handleOffset.left + handleWidth + 8 ; //为什么要 + 9，因为popover的left临界点不是箭头，而是主体部分, 9 是箭头的高度
                top = handleOffset.top - (popoverHeight - handleHeight) / 2 ;
            }
            else if (opts.placement === "bottom") {
                left = handleOffset.left - (popoverWidth - handleWidth) / 2 ;
                top = handleOffset.top + handleHeight + 8 ;
            }
            else if (opts.placement === "left") {
                left = handleOffset.left - popoverWidth - 8 ;
                top = handleOffset.top - (popoverHeight - handleHeight) / 2 ;
            }
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            先定位弹出框位置
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(popover).css({"left" : left + "px" , "top" : top + "px"}) ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            再将弹出框隐藏
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(popover).css({"visibility" : "hidden"}) ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            为元素绑定事件监听器
             -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            if(opts.trigger === "click") {
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                为句柄绑定事件
                 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                $(this).bind(opts.trigger, function(event) {                   
                    $.fn.popover.pop(popover, opts.delay) ;
                    event.stopPropagation() ;
                }) ;
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                阻止页面点击其他地方隐藏弹窗在弹窗本身冒泡
                 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                $(popover).click(function(event){
                    event.stopPropagation() ;
                }) ;
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                点击页面其他地方的时候隐藏改弹出框
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                $(document).click(function() {                    
                    $.fn.popover.hide(popover, opts.delay) ;
                }) ;
            }
            else if(opts.trigger === "hover") {
                $(this).hover(function(){ $.fn.popover.pop(popover, opts.delay) ; }, function(){ $.fn.popover.hide(popover, opts.delay) ; }) ;
                $(popover).hover(function(){ $.fn.popover.pop(popover, opts.delay) ; }, function(){ $.fn.popover.hide(popover, opts.delay) ; }) ;
            }
        });
       
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    弹出框的方法
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.popover.pop = function(popover, delay) {
        delay = (typeof delay === "object") ? delay.show : delay ;
        window.setTimeout(function(){
            $(popover).css({"visibility" : "visible"}) ;
        }, delay) ;
    }
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    隐藏窗口的方法
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.popover.hide = function(popover, delay) {
        delay = (typeof delay === "object") ? delay.hide : delay ;
        window.setTimeout(function(){
            $(popover).css({"visibility" : "hidden"}) ;
        }, delay) ;        
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    创建弹出框dom节点
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.popover.create = function(opts) {
        var popover = $(document.createElement("DIV")).addClass("popover " + opts.placement) ;
        var arrow = $(document.createElement("DIV")).addClass("arrow").append($(document.createElement("DIV")).addClass("arrow-inner")) ;
        $(popover).append(arrow) ;         
        var title = $(document.createElement("DIV")).addClass("popover-title").html(opts.title) ;
        $(popover).append(title) ;
        if( ! opts.title) {
            $(title).hide() ;
            if(opts.placement === "bottom") $(arrow).find(".arrow-inner").css({"border-color" : "transparent transparent #fff"}) ;  
        }
        title = null ;
        var content = $(document.createElement("DIV")).addClass("popover-content") ;
        if(typeof opts.content === "string") $(content).html(opts.content) ;
        else if(typeof opts.content === "object") {
            $(opts.content).show() ;
            $(content).append(opts.content) ;
        }
        $(popover).append(content) ;
        content = null ;
        if(opts.id) $(popover).attr("id", opts.id) ;
        if(opts.width) $(popover).css({"width" : opts.width + "px"}) ;        
       return popover ;
    } ;
    
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    popover默认配置
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.popover.defaults = {       
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        弹出框显示的时候不一定就一定贴着句柄，也可以贴到任何元素下，这个参数就是用来指定贴到哪里，如果这里为空，就是贴到句柄下
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        container : null ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        弹出框内容：可以是文本字符串 | html字符串 | 指定的dom节点，如果是dom节点将直接append过去，默认为空
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        content : "" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        弹出延时，单位为毫秒，默认为0，就是不延时，也可以是对象格式：{"show" : 500 , "hide" : 100 }来表示显示的时候延时和隐藏的时候延时的不同
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        delay : 0 ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        弹出框的id值
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        id : null ,        
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        弹出框相对句柄的位置：left | top | right | bottom，默认为bottom
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        placement : "bottom" ,        
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        弹窗的title信息，可以是html信息，默认为空，如果为空就不显示title栏目，而且如果是bottom类型的箭头也会改成和白色这样就融洽了
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        title : "" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        触发弹出框的触发事件：click | hover，默认为click
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        trigger : "click" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        弹窗宽度，如果不设置，宽度将根据内容
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        width : null
    } ;
})(jQuery) ;
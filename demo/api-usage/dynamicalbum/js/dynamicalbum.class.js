/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
1. 类名称：dynamicalbum
2. 类描述：动态相册，可以初始化赋予相册图片清单，可以动态添加图片，也可以动态删除图片
3. 版本：1.0
4.  对其他插件的依赖：
    jquery.artDialog.js用来规范提示信息
5. 备注：    
6. 未尽事宜：
7. 作者：huagang.zhao@51auto.com
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
function dynamicalbum(params){
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    需要放相册的容器
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.container = (params==null || params.container==null) ? null : params.container ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    容器添加的class
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.containerClass = (params==null || params.containerClass==null) ? "album-conainer" : params.containerClass ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    初始化图片清单
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.initPictList = (params==null || params.initPictList==null) ? [] : params.initPictList ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    删除图片是否需要确认
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.removeConfirm = (params==null || params.removeConfirm==null) ? true : params.removeConfirm ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    删除单张图片是否需要同步服务器
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.removeSyncServer = (params==null || params.removeSyncServer==null) ? false : params.removeSyncServer ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    动态删除图片的后台API地址
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.removePictApiUrl = (params==null || params.removePictApiUrl==null) ? null : params.removePictApiUrl ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    删除图片的接口事件
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.onRemove = (params==null || params.onRemove==null) ? null : params.onRemove ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    初始化
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.init();
    
}
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
初始化方法定义
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
dynamicalbum.prototype.init = function(){
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    把css文件给动态加载进来
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $("head").append($(document.createElement("LINK")).attr("rel", "stylesheet").attr("href", "http://cdn01.51autoimg.com/51auto/css/dynamic-album.min.css")) ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    给容器添加指定的class名称
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $(this.container).addClass(this.containerClass) ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    清空容器
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $(this.container).empty();
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    根据初始化图片清单进行渲染
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    var da = this ;
    $.each(this.initPictList, function(i, pict){
        da.add(pict);
    });
}
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
添加图片方法定义
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
dynamicalbum.prototype.add = function(pict){
    var da = this ;
    var dl = document.createElement("DL");
    $(dl).append($(document.createElement("DT")).append($(document.createElement("IMG")).attr("src", pict.url).attr("data-id", pict.id))) ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    删除按钮的绘制
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    var removeA = $(document.createElement("A")).text("移除") ;    
    $(removeA).bind("click", function(){                
        var pn = $(this).parent();
        while($(pn)[0].tagName.toUpperCase() != "DL") pn = $(pn).parent() ;
        if(da.removeConfirm) {
            art.dialog.confirm("你确定要移除这张图片吗？", function () {
                 da.remove(pn);
            }, function () {
                art.dialog.tips("您取消了移除操作");
            });
        }
        else da.remove(pn);             
    });
    var alertUrlA = $(document.createElement("A")).text("显示图片地址") ; 
    $(alertUrlA).bind("click", function(){
        var pn = $(this).parent();
        while($(pn)[0].tagName.toUpperCase() != "DL") pn = $(pn).parent() ;
        art.dialog.alert($(pn).find("dt img").attr("src"));
    });
    $(dl).append($(document.createElement("DD")).append(removeA).append(alertUrlA)) ;
    $(this.container).append(dl) ;    
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    断开dom与变量的关联，防止内存泄露
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    removeA = null ; 
    alertUrlA = null ;
    dl = null ;
}
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
删除图片方法定义
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
dynamicalbum.prototype.remove = function(dl){
    var da = this ;
    var dialog = art.dialog.tips("正在执行图片移除操作，请稍等...", 100);
    if(this.removeSyncServer) {
        try {
             $.ajax({
                url : this.removePictApiUrl  ,
                data : {
                    "id" : $(dl).find("dt img").attr("data-id")
                },
                type : "GET",
                dataType : "json",
                async : true ,
                error : function(e) {
                    dialog.close();
                    art.dialog.alert("调用移除图片API失败 ! ");
                },
                success : function(result){
                    dialog.close();
                    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                     根据返回结果进行操作，结果json串格式应该是：
                    {
                        "error" : true , //如果有错误信息，这里就是true，否则写false
                        "message" : "您没有权限进行图片操作"
                    }
                    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                    if(result.error) art.dialog.alert(result.message);
                    else {
                        $(dl).remove() ;
                        if(da.onRemove) da.onRemove() ;
                        art.dialog.tips("删除图片成功 ！ ", 1);
                    }
                }
            });

        }
        catch(e) {
            dialog.close();
            art.dialog.alert("错误名称："+e.name+"\n错误描述："+e.message);
        }
    }
    else {
        dialog.close();
        $(dl).remove();
        if(da.onRemove) da.onRemove() ;
        art.dialog.tips("删除图片成功 ！ ", 1);
    }
}
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
将图片id汇总到某个表单元素的值中供提交使用
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
dynamicalbum.prototype.union = function(formControl, separator){
    var separator = separator || "&" ;
    var output = "";
    $(this.container).find("dt img").each(function(){
        if(output != "") output += separator ;
        output += $(this).attr("data-id").toString() ;
    });
    $(formControl).val(output);
}
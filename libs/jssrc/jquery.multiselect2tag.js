/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 插件名称：multiselect2tag
 2. 插件描述：从select框多选到tag形式的选项，tag可以移除掉
 3. 版本：1.0
 4.  对其他插件的依赖：无
 5. 作者：zhaohuagang@guanaihui.com
 6. 未尽事宜：
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
(function($) {
    $.fn.multiselect2tag = function(options) {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        multiselect2tag加上对应的配置属性
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var opts = $.extend({}, $.fn.multiselect2tag.defaults, options) ;        
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
         执行事件添加后返回
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        return this.each(function() {            
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            为多选的select创建一个结果tag容器
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/            
            $.fn.multiselect2tag.appendResultContainer(this) ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            创建初始化数据
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/  
            $.fn.multiselect2tag.init(this, $(this).next(".multiselect2tag-result-container"), opts) ;
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            onchange的时候先检查是否已经添加，如果没有，就添加到下面结果tag容器，并将新的汇总值写到select的属性值里面
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(this).change(function(){               
                if($.fn.multiselect2tag.testRepeat($(this).val(), $(this).next(".multiselect2tag-result-container"), opts)) return false ;
                $.fn.multiselect2tag.addTag($(this).find("option:selected").text(), $(this).val(), $(this).next(".multiselect2tag-result-container"), opts) ;
                $.fn.multiselect2tag.total($(this).next(".multiselect2tag-result-container"), opts) ;
                if(opts.selectChangeInterface) opts.selectChangeInterface() ;
                $(this).val(opts.emptyValue) ;
            }) ;
        });
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    根据给定的隐藏域里面的初始值来绘制初始状态的选中tag
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.multiselect2tag.init = function(select, resultContainer, opts) {
        var initValue = $(opts.dataSaveInto).val() ;        
        if( ! initValue) return ;
        var tagValueArray = initValue.split(opts.separator) ;       
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        先将select的label和value转成一个对象格式
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var keyValueObject= {} ;
        $(select).find("option").each(function(){
            if($(this).attr("value") !== opts.emptyValue) keyValueObject[$(this).attr("value").toString()] = $(this).text() ;
        }) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        再依次创建初始化状态tag
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/        
        $.each(tagValueArray, function(){
            $.fn.multiselect2tag.addTag(keyValueObject[this], this, resultContainer, opts) ;
        }) ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    为多选的select创建一个结果tag容器，如果已经存在这样一个容器就什么都不干
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.multiselect2tag.appendResultContainer = function(select) {
        if($(select).next(".multiselect2tag-result-container").size() > 0) return ;
        $(select).after($(document.createElement("DIV")).addClass("multiselect2tag-result-container")) ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    检查给定的value的选项在下面的tag中是否存在
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.multiselect2tag.testRepeat = function(value, resultContainer, opts) {
        if(value === opts.emptyValue) return true ;  //如果是指定的空值也表示重复
        var valueArray = new Array ;
        $(resultContainer).find(".item").each(function(){
            valueArray.push($(this).attr("data-id").toString()) ;
        }) ;
        if($.inArray(value.toString(), valueArray) != -1) return true ;
        else return false ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    创建一个tag节点
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.multiselect2tag.addTag = function(label, value, resultContainer,opts) {
        var item = $(document.createElement("A")).addClass("item").attr("href", "javascript:void(0);").attr("data-id", value) ;
        var description = $(document.createElement("SPAN")).addClass("description").text(label) ;
        var close = $(document.createElement("SPAN")).addClass("close").append("<i class=\"iconfont icon-shanchu\"></i>") ;
        $(close).click(function(){
            $(this).parent().remove() ;
            $.fn.multiselect2tag.total(resultContainer,opts) ;
            if(opts.tagRemoveInterface) opts.tagRemoveInterface() ;
        }) ;
        $(item).append(description).append(close) ;
        description = null ;
        close = null ;
        $(resultContainer).append(item) ;
        item = null ;
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    汇总结果容器里面的tag值
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.multiselect2tag.total = function(resultContainer, opts) {
        var resultArray = new Array ;
        $(resultContainer).find(".item").each(function(){
            resultArray.push($(this).attr("data-id").toString()) ;
        }) ;
        $(opts.dataSaveInto).val(resultArray.join(opts.separator)) ; 
    } ;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
     multiselect2tag默认配置
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $.fn.multiselect2tag.defaults = {       
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        多选的select在最终提交的时候对选中的tag的value进行组合的时候用到的分隔符，默认为逗号
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        separator : "," ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        组合好的值储存在哪个dom元素的value里面好提交，一般是一个隐藏域
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        dataSaveInto : null ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        select的请选择项的value，默认为""
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        emptyValue : "" ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        select的change后的接口事件
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        selectChangeInterface : null ,
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        tag被remove后的接口事件
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        tagRemoveInterface : null
    } ;
})(jQuery) ;